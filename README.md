# Lviv Oblenergo Schedule Sync

Автоматизований збір графіків планових відключень електроенергії з офіційного ресурсу ПрАТ «Львівобленерго», візуалізація та синхронізація з Google Calendar.

## Можливості

- Багатоканальна синхронізація. Інтеграція розкладів кількох черг у окремі календарі (власна черга — в основний, інші — в додаткові).
- Оптимізація запитів. Оновлення подій відбувається лише при зміні графіка або настанні нової доби.
- Автоматична очистка. За відсутності планових відключень на поточну добу видаляються неактуальні події типу «Нема світла».
- Аналітика та історія. Збереження історії відключень із переглядом статистики.
- Інтерфейс. Структурований, інформативний вивід у термінал.

## Вимоги

- Python 3.9+
- Git
- Можливість встановлення браузерного рушія для скрапінгу (Chromium через Playwright)
- Облікові дані Google API для доступу до Google Calendar

## Швидкий старт

1) Клонування репозиторію
- Виконайте:
  ```
  git clone https://github.com/your-username/loe-sync.git
  cd loe-sync
  ```

2) Створення та активація віртуального середовища
- Створіть середовище:
  ```
  python -m venv venv
  ```
- Активуйте:
  - Windows (PowerShell):
    ```
    .\venv\Scripts\Activate
    ```
  - macOS/Linux:
    ```
    source venv/bin/activate
    ```

3) Інсталяція залежностей
- Встановіть пакети:
  ```
  pip install -r requirements.txt
  ```

4) Встановлення браузерного рушія для скрапінгу
- Встановіть Chromium для Playwright:
  ```
  playwright install chromium
  ```

## Налаштування Google API

1) Створення проекту
- Перейдіть до Google Cloud Console.
- Створіть проект: Create Project.

2) Увімкнення API
- Відкрийте API Library.
- Знайдіть та увімкніть Google Calendar API (кнопка Enable).

3) Налаштування OAuth consent screen
- Перейдіть APIs & Services → OAuth consent screen.
- Тип користувача: External.
- Заповніть обов’язкові поля (App Name, контактні дані).
- Додайте власну адресу Gmail до Test users. Інакше доступ буде заблоковано.

4) Створення OAuth Client ID
- Перейдіть Credentials → Create Credentials → OAuth client ID.
- Application type: Desktop app.
- Name: LOE Sync Client.
- Завантажте JSON, перейменуйте на credentials.json і помістіть у корінь проекту.

Примітка: Під час першого запуску відкриється вікно браузера для OAuth. Після підтвердження з’явиться файл token.json, який дозволить наступні запуски без повторної авторизації.

## Конфігурація середовища

1) Змінні середовища (.env)
- Створіть файл .env у корені (можна взяти за основу .env.example):
  ```
  LOE_URL="https://poweron.loe.lviv.ua/"
  OUTPUT_DIR="schedules"
  TIMEZONE="Europe/Kyiv"
  ```

2) Маршрутизація календарів (config.yaml)
- Створіть файл config.yaml з часовою зоною і картами груп → календарі:
  ```yaml
  timezone: "Europe/Kyiv"

  calendars:
    # Формат: "Номер групи": "ID календаря"
    "4.1": "primary"
    "2.1": "c_a1b2c3d4e5...@group.calendar.google.com"
    # Можна додавати необмежену кількість груп
    # "1.1": "primary"
  ```

Підказка щодо Calendar ID:
- Основний календар: primary.
- Додаткові: Settings → Обрати календар → Integrate calendar → Calendar ID (формат: c_abc123...@group.calendar.google.com).

## Запуск

- Ініціалізуйте синхронізацію:
  ```
  python sync_google.py
  ```

Очікувана поведінка:
- На першому запуску з’явиться вікно OAuth-авторизації.
- Після успіху збережеться token.json для майбутніх сеансів.

## Автоматизація (cron)

- Відкрийте редактор:
  ```
  crontab -e
  ```
- Додайте запис (оновлення щогодини о 15-й хвилині):
  ```
  15 * * * * cd /home/user/loe-sync && /home/user/loe-sync/venv/bin/python sync_google.py >> /tmp/loe_sync.log 2>&1
  ```

Поради:
- Укажіть реальні шляхи до вашого каталогу і Python у venv.
- Переконайтесь, що в середовищі cron доступні змінні PATH і змінні з .env (за потреби задайте повні шляхи або використайте wrapper-скрипт).

## Як це працює

- Збір графіків. Скрипт отримує актуальний графік планових відключень з офіційного джерела і формує події.
- Мінімізація змін. Оновлення календарів відбувається лише при зміні джерела або з настанням нової доби (контроль хеш-сум).
- Прибирання шуму. За відсутності відключень на сьогодні видаляються старі події «Нема світла».
- Багатокалендарність. Події різних черг автоматично розкладаються по вказаних календарях.

## Усунення несправностей

- Помилка: Token has been expired or revoked
  - Видаліть token.json і запустіть скрипт знову, пройдіть авторизацію.

- Помилка: Access blocked: app has not completed the Google verification
  - Перевірте, що ваш акаунт додано у Test users на сторінці OAuth consent screen.

- Події не оновлюються в календарі
  - Якщо хеш-сума даних на сайті не змінилась, система не створює/не редагує події — це нормальна оптимізація квот API.
  - Перевірте часову зону у .env та config.yaml (має відповідати Europe/Kyiv).
  - Переконайтесь, що календарні ID в config.yaml валідні та мають права доступу.

## Структура проекту

- sync_google.py — головний скрипт синхронізації.
- config.yaml — маршрутизація груп до календарів.
- .env — змінні середовища (URL, директорія виводу, таймзона).
- credentials.json — OAuth-клієнт Google (не комітьте в репозиторій).
- token.json — токен авторизації, генерується автоматично.
- schedules/ — кеш/артефакти парсингу та історія (якщо передбачено).
